<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KET Speaking Master ¬∑ Unit 1 Making Friends</title>
  <style>
    :root{
      --ink:#1E2A44; --mut:#5A6A86; --bg:#F6FBFF; --card:#FFFFFF;
      --stroke:rgba(30,42,68,.12); --shadow:0 18px 40px rgba(30,42,68,.10);
      --blue:#4D96FF; --pink:#FB7185; --green:#22C55E; --purple:#8B5CF6; --amber:#FBBF24;
      --radius:24px; --pad:52px; --padM:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color:var(--ink); overflow:hidden; background:linear-gradient(120deg, var(--bg), #FFF6FB);
    }
    /* Progress & Score */
    .score-bar{
      position:fixed; top:20px; left:20px; right:20px; z-index:1000;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 16px; border-radius:999px; background:var(--card);
      border:1px solid var(--stroke); box-shadow:var(--shadow);
      font-size:14px; font-weight:600;
    }
    .score{display:flex; align-items:center; gap:8px}
    .stars{font-size:18px}
    .star{color:rgba(251,191,36,.3); transition:color .3s}
    .star.earned{color:var(--amber)}
    .level{color:var(--purple)}
    
    #deck{height:100vh;width:100vw;position:relative}
    .slide{
      position:absolute; inset:0; padding:var(--pad) var(--pad) 92px;
      display:none; background:var(--bg);
    }
    .slide.active{display:block}
    @media (max-width: 980px){.slide{padding:46px var(--padM) 92px}}
    
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:14px; padding-bottom:10px; border-bottom:2px solid rgba(77,150,255,.15);
    }
    .badge{
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px;
      border-radius:999px; background:var(--card); border:1px solid var(--stroke);
      box-shadow:var(--shadow); font-size:14px; color:var(--mut);
    }
    .badge .dot{
      width:10px; height:10px; border-radius:50%;
      background:linear-gradient(135deg, var(--blue), var(--purple));
    }
    .micro-target{margin-top:6px; font-size:13px; color:var(--green); font-weight:600}
    
    .wrap{
      height:calc(100vh - 92px - 46px); display:grid; grid-template-columns:1fr 1fr; gap:16px;
    }
    .wrap.one{grid-template-columns:1fr}
    @media (max-width: 980px){.wrap{grid-template-columns:1fr}}
    
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:20px; overflow:auto; position:relative;
    }
    .card.soft{background:linear-gradient(180deg, rgba(244,248,255,.92), rgba(255,255,255,.92))}
    
    h1{margin:0 0 10px; font-size:36px; letter-spacing:.2px}
    h2{margin:0 0 10px; font-size:26px; display:flex; align-items:center; gap:10px}
    .sub{color:var(--mut); font-size:16px; line-height:1.55; margin-bottom:12px}
    .big{font-size:18px; line-height:1.65}
    .mini{font-size:14px; color:var(--mut); line-height:1.55}
    
    .turn{
      margin-top:16px; padding:14px; border-radius:18px;
      border:2px dashed var(--blue); background:rgba(77,150,255,.05);
    }
    .turn .tTitle{
      display:flex; align-items:center; gap:10px; font-size:16px; color:var(--ink);
      margin-bottom:8px; user-select:none; font-weight:600;
    }
    .turn ul{margin:8px 0 0; padding-left:18px; color:var(--mut); line-height:1.6}
    .turn li{margin-bottom:6px}
    
    .grid6{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:12px;
    }
    @media (max-width: 980px){.grid6{grid-template-columns:repeat(2, 1fr)}}
    
    .tile{
      border-radius:18px; border:1px solid var(--stroke); background:var(--card);
      box-shadow:0 12px 26px rgba(30,42,68,.08); padding:14px; cursor:pointer;
      user-select:none; transition:all .2s ease; min-height:110px; position:relative;
    }
    .tile:hover{transform:translateY(-2px)}
    .tile:active{transform:translateY(1px)}
    .tile.speaking{
      background:var(--blue); color:#fff; border-color:var(--blue);
      animation:pulse .8s ease-in-out;
    }
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    .tile.revealed{outline:3px solid var(--blue);}
    .tile.correct{outline:3px solid var(--green);}
    .tile.wrong{outline:3px solid var(--pink); animation:shake .4s ease;}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
    
    .tag{
      position:absolute; top:10px; right:10px; padding:6px 10px; border-radius:999px;
      font-size:12px; border:1px solid var(--stroke); background:rgba(255,255,255,.85);
      color:var(--mut);
    }
    .w{display:flex; align-items:flex-start; gap:10px}
    .icon{width:28px; height:28px; flex:0 0 auto}
    .word{font-size:18px; color:var(--ink); font-weight:500}
    .hint{margin-top:8px; color:var(--mut); font-size:14px; line-height:1.5}
    
    .tile .front{opacity:1; transition:opacity .3s}
    .tile .back{display:none; opacity:0}
    .tile.revealed .front{display:none; opacity:0}
    .tile.revealed .back{display:block; opacity:1}
    
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      appearance:none; border:none; cursor:pointer; padding:12px 14px; border-radius:14px;
      font-size:14px; background:var(--card); border:1px solid var(--stroke);
      color:var(--ink); box-shadow:0 10px 22px rgba(30,42,68,.08);
      transition:all .15s ease; position:relative;
    }
    button.primary{background:rgba(34,197,94,.14); border-color:rgba(34,197,54,.22)}
    button.blue{background:rgba(77,150,255,.14); border-color:rgba(77,150,255,.22)}
    button.pink{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.22)}
    button.amber{background:rgba(251,191,36,.14); border-color:rgba(251,191,36,.22)}
    button.purple{background:rgba(139,92,246,.14); border-color:rgba(139,92,246,.22)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.45; cursor:not-allowed}
    
    .challenge-box{
      margin-top:16px; padding:14px; border-radius:16px;
      border:2px solid var(--amber); background:rgba(251,191,36,.08);
    }
    .challenge-box h3{margin:0 0 8px; color:var(--amber); font-size:18px}
    
    .dialogue-box{
      background:linear-gradient(135deg, rgba(77,150,255,.05), rgba(251,113,133,.05));
      border:1px solid var(--stroke); border-radius:16px; padding:16px;
      margin-top:12px;
    }
    .dialogue-line{
      padding:10px; margin:6px 0; border-radius:10px; background:#fff;
      box-shadow:0 4px 8px rgba(30,42,68,.04); font-size:16px; cursor:pointer;
      transition:all .3s ease;
    }
    .dialogue-line:hover{transform:translateX(4px)}
    .dialogue-line:active{transform:scale(.98)}
    .dialogue-line.teacher{border-left:4px solid var(--blue)}
    .dialogue-line.student{border-left:4px solid var(--green)}
    
    #nav{
      position:absolute; left:18px; right:18px; bottom:14px; height:54px;
      border-radius:18px; background:rgba(255,255,255,.86); border:1px solid var(--stroke);
      box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; gap:10px; user-select:none;
    }
    .navBtn{
      padding:10px 12px; border-radius:14px; cursor:pointer; font-size:14px; white-space:nowrap;
      background:rgba(77,150,255,.12); border:1px solid rgba(77,150,255,.2);
    }
    .navBtn.secondary{background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.2);}
    .navBtn:disabled{opacity:.45; cursor:not-allowed}
    .center{
      flex:1; display:flex; align-items:center; justify-content:center; gap:10px;
      min-width:260px; color:var(--mut); font-size:14px;
    }
    .progress{
      height:8px; width:220px; background:rgba(30,42,68,.10);
      border-radius:999px; overflow:hidden; border:1px solid rgba(30,42,68,.08);
    }
    .bar{
      height:100%; width:0%; background:linear-gradient(135deg, var(--blue), var(--purple));
      border-radius:999px; transition:width .2s ease;
    }
  </style>
</head>

<body>
<!-- Score & Progress Bar -->
<div class="score-bar">
  <div class="level">LEVEL <span id="currentLevel">1</span></div>
  <div class="score">
    Score: <span id="userScore">0</span>pts
    <div class="stars">
      <span class="star" id="star1">‚≠ê</span>
      <span class="star" id="star2">‚≠ê</span>
      <span class="star" id="star3">‚≠ê</span>
    </div>
  </div>
</div>

<div id="deck"></div>

<script>
/* =========================
   SVG Icon Library (Complete)
   ========================= */
function svgIcon(type){
  const s = 'stroke="rgba(30,42,68,.35)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"';
  const icons = {
    tag: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M4 7.5C4 6.1 5.1 5 6.5 5h11C19 5 20 6.1 20 7.5v9C20 17.9 18.9 19 17.5 19h-11C5.1 19 4 17.9 4 16.5v-9Z"/><path d="M7 9h10" stroke="#4D96FF" stroke-width="2.2"/><path d="M7 12h7" stroke="#FB7185" stroke-width="2.2"/></svg>`,
    clock: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10Z"/><path d="M12 6v6l4 2" stroke="#4D96FF" stroke-width="2.2"/></svg>`,
    user: `<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" ${s}/><path ${s} d="M4 20a8 8 0 0 1 16 0"/></svg>`,
    school: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M4 10.5 12 6l8 4.5v8.2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8.2Z"/><path d="M9 20v-6h6v6" stroke="#4D96FF" stroke-width="2.2"/></svg>`,
    book: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M6 4h10a2 2 0 0 1 2 2v14H8a2 2 0 0 0-2 2V4Z"/><path d="M8 7h8" stroke="#22C55E" stroke-width="2.2"/></svg>`,
    chat: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M3 20v-4a8 8 0 0 1 16 0v4M3 20h6M3 16h8"/><circle cx="18" cy="10" r="2" fill="var(--pink)" opacity=".3"/></svg>`,
    trophy: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M8 21h8M10 17h4M12 3v4M6 5v3a6 6 0 0 0 12 0V5M5 5H3a2 2 0 0 0 2 2M19 5h2a2 2 0 0 1-2 2"/></svg>`,
    bolt: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M13 2 4 14h7l-1 8 10-12h-7Z"/><path d="M11 14h7" stroke="#FBBF24" stroke-width="2.2"/></svg>`,
    heart: `<svg class="icon" viewBox="0 0 24 24"><path d="M12 21s-7-4.4-7-10.2C5 6.1 8.6 3 12 3s7 3.1 7 7.8C19 16.6 12 21 12 21Z" fill="rgba(251,113,133,.25)" stroke="#FB7185" stroke-width="2"/></svg>`
  };
  return icons[type] || `<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="rgba(77,150,255,.18)"/></svg>`;
}

/* =========================
   Score & Progress System (Complete)
   ========================= */
let userScore = 0, starsEarned = 0, currentLevel = 1;
function updateScore(points, action = ''){
  userScore += points;
  document.getElementById('userScore').textContent = userScore;
  
  // Level up every 150 points
  const newLevel = Math.floor(userScore / 150) + 1;
  if(newLevel > currentLevel){
    currentLevel = newLevel;
    document.getElementById('currentLevel').textContent = currentLevel;
    alert(`üéâ Level Up! You're now Level ${currentLevel}!`);
  }
  
  // Star system: 1 star per 100 points
  const newStars = Math.floor(userScore / 100);
  for(let i = 1; i <= 3; i++){
    const star = document.getElementById(`star${i}`);
    if(i <= newStars){
      star.classList.add('earned');
    } else {
      star.classList.remove('earned');
    }
  }
}

/* =========================
   Interactive Component Generators
   ========================= */
function makeTileCard(item, tag){
  const tile = document.createElement('div');
  tile.className = 'tile';
  tile.innerHTML = `
    <div class="tag">${tag}</div>
    <div class="front">
      <div class="w">${svgIcon(item.ic || 'book')}
        <div><div class="word">${item.w}</div>
        <div class="hint">Tap to speak & reveal</div></div>
      </div>
    </div>
    <div class="back">
      <div class="mini"><b>${item.q || 'Say it!'}</b></div>
      <div class="hint">${item.a}</div>
      <div class="hint" style="margin-top:6px; color:var(--green)">+ Add detail</div>
    </div>
  `;
  
  tile.addEventListener('click', function(){
    if(this.classList.contains('speaking')) return;
    this.classList.add('speaking');
    
    // Simulate speaking practice
    setTimeout(()=>{
      this.classList.remove('speaking');
      this.classList.add('revealed');
      updateScore(10, 'vocab');
    }, 1200);
  });
  
  return tile;
}

function makeDialogueBox(lines){
  const box = document.createElement('div');
  box.className = 'dialogue-box';
  lines.forEach((line, i)=>{
    const div = document.createElement('div');
    div.className = `dialogue-line ${i%2===0 ? 'teacher' : 'student'}`;
    div.textContent = line;
    div.onclick = ()=>{
      div.style.background = 'var(--green)';
      div.style.color = '#fff';
      setTimeout(()=>{div.style.background='#fff'; div.style.color='var(--ink)';}, 500);
      updateScore(5, 'dialogue');
      
      // Track role-play progress
      if(line.includes('Student:') && !window.roleAComplete){
        window.roleAComplete = true;
        document.getElementById('progressA').style.opacity = '1';
        document.getElementById('progressB').style.opacity = '1';
      } else if(line.includes('Student:') && window.roleAComplete && !window.roleBComplete){
        window.roleBComplete = true;
        updateScore(30, 'roleComplete');
      }
    };
    box.appendChild(div);
  });
  return box;
}

/* =========================
   Complete Slide Definitions (12 Slides)
   ========================= */
const slideDefs = [
  // 1. THEME INTRODUCTION
  {
    title:"Lesson Start", stage:"1. Theme", one:true,
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>Making Friends & Introductions</h1>
          <div class="sub">KET Speaking Unit 1 | 15 Interactive Tasks</div>
          <div class="scene" style="height:200px; background:linear-gradient(135deg, rgba(77,150,255,.1), rgba(251,113,133,.08)); border-radius:20px; display:grid; place-items:center; font-size:18px">
            <div style="text-align:center">
              <div style="font-size:48px; margin-bottom:12px">üëãü§ù</div>
              <div>How can we make friends at school?</div>
            </div>
          </div>
          <div class="challenge-box">
            <h3>Today's Mission</h3>
            <div class="big">‚úì 10 Core Words | ‚úì 5 Key Sentences | ‚úì 3 Dialogues</div>
            <div class="big">‚úì 40-50 sec Speech | ‚úì High-scoring Expressions</div>
          </div>
          <div class="turn">
            <div class="tTitle">üéØ Let's Begin!</div>
            <ul>
              <li>Tap the cards to learn vocabulary</li>
              <li>Practice each dialogue with points</li>
              <li>Build up to final speaking test</li>
            </ul>
          </div>
          <div class="micro-target">Progress: 0% | Score: <span id="initialScore">0</span>pts</div>
        </div>
      `;
    },
    onMount: ()=>{
      document.getElementById('initialScore').textContent = userScore;
    }
  },

  // 2. CORE VOCABULARY
  {
    title:"Core Vocabulary", stage:"2. Vocabulary", rightMeta:"10 Words",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('book')} Core Words</h2>
          <div class="sub">Tap each card ‚Üí Listen ‚Üí Repeat ‚Üí Act it out!</div>
          <div class="grid6" id="coreVocab"></div>
          <div class="turn">
            <div class="tTitle">üé§ Action Challenge</div>
            <ul>
              <li>Tap card: Listen to "wave your hand"</li>
              <li>Do the action while speaking</li>
              <li>+10pts per correct action!</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Word Power</h2>
          <div class="sub">Use these words in sentences:</div>
          <div class="btnRow" id="powerWords"></div>
          <div class="challenge-box">
            <h3>Speed Round</h3>
            <div>Answer 10 questions in 60 seconds</div>
            <button class="amber" onclick="startVocabRace()">Start Race</button>
            <div>Score: <span id="raceScore">0</span></div>
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      const vocab = [
        {w:"name", q:"What's your name?", a:"My name is ___."},
        {w:"friend", q:"Who is your friend?", a:"My friend is ___."},
        {w:"wave", q:"Wave your hand", a:"Hello! (wave)"},
        {w:"point", q:"Point to your eye", a:"This is my eye."},
        {w:"look", q:"Look at me", a:"I look at you."},
        {w:"hand", q:"Show your hand", a:"This is my hand."},
        {w:"arm", q:"Wave your arm", a:"Bye-bye! (wave arm)"},
        {w:"eye", q:"Wink your eye", a:"I can wink!"},
        {w:"ear", q:"Point to your ear", a:"I listen with my ear."},
        {w:"mouth", q:"Point to your mouth", a:"I speak with my mouth."}
      ];
      
      const host = document.getElementById('coreVocab');
      vocab.forEach(item=>{
        item.ic = 'tag';
        host.appendChild(makeTileCard(item, 'CORE'));
      });
      
      const powerHost = document.getElementById('powerWords');
      ["friendly","helpful","nice","happy"].forEach((w,i)=>{
        const btn = document.createElement('button');
        btn.className = i%2===0 ? 'blue' : 'pink';
        btn.textContent = w;
        btn.onclick = ()=>updateScore(5, 'power');
        powerHost.appendChild(btn);
      });
    }
  },

  // 3. KEY SENTENCES
  {
    title:"Key Sentences", stage:"3. Sentences", rightMeta:"5 Patterns",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('chat')} Master Patterns</h2>
          <div class="sub">Tap each line to practice. Speak it out loud!</div>
          <div id="sentencePatterns"></div>
          <div class="turn">
            <div class="tTitle">Pattern Challenge</div>
            <ul>
              <li>Tap each pattern 3 times</li>
              <li>Change the blank parts</li>
              <li>+5pts per correct variation</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Build Variations</h2>
          <div class="sub">Make 3 versions of each pattern:</div>
          <div id="variationBuilder"></div>
          <div class="challenge-box">
            <h3>Variation Master</h3>
            <div>15 variations = +30pts bonus</div>
            <div>Progress: <span id="varCount">0</span> / 15</div>
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      const patterns = [
        "My name is _____.",
        "I'm _____ years old.",
        "I live in _____.",
        "I study at _____ School.",
        "Nice to meet you, _____."
      ];
      
      const host = document.getElementById('sentencePatterns');
      let variationCount = 0;
      patterns.forEach((pattern, i)=>{
        const div = document.createElement('div');
        div.className = 'dialogue-line';
        div.style.cursor = 'pointer';
        div.textContent = pattern;
        div.onclick = function(){
          this.style.background = 'var(--green)';
          this.style.color = '#fff';
          setTimeout(()=>{this.style.background='#fff'; this.style.color='var(--ink)';}, 500);
          updateScore(3, 'sentence');
          
          variationCount++;
          document.getElementById('varCount').textContent = Math.min(variationCount, 15);
          if(variationCount === 15){
            updateScore(30, 'bonus');
          }
        };
        host.appendChild(div);
      });
      
      // Build variation buttons
      const builder = document.getElementById('variationBuilder');
      const names = ['Alex','Sam','Lisa','Tom'];
      const places = ['Beijing','London','New York','Sydney'];
      
      names.forEach(n=>{
        const btn = document.createElement('button');
        btn.textContent = n;
        btn.className = 'blue';
        btn.onclick = ()=>updateScore(2, 'name');
        builder.appendChild(btn);
      });
      places.forEach(p=>{
        const btn = document.createElement('button');
        btn.textContent = p;
        btn.className = 'pink';
        btn.onclick = ()=>updateScore(2, 'place');
        builder.appendChild(btn);
      });
    }
  },

  // 4. DIALOGUE 1
  {
    title:"Dialogue 1", stage:"4. Dialogue", rightMeta:"Listen & Repeat",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('user')} Teacher-Student Model</h2>
          <div class="sub">Tap each line to hear and repeat. Get points!</div>
          <div id="dialogue1"></div>
          <div class="turn">
            <div class="tTitle">Role-Play Ready?</div>
            <ul>
              <li>Student: Tap your lines</li>
              <li>Teacher: Tap teacher lines</li>
              <li>Complete dialogue = +25pts</li>
            </ul>
          </div>
          <div id="dialogue1Score" style="text-align:center; margin-top:12px; font-size:18px; color:var(--purple)">Score: 0 / 25</div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Dialogue Tips</h2>
          <div class="sub">For better communication:</div>
          <div style="display:grid; gap:8px; font-size:14px">
            <div style="padding:10px; background:#fff; border-radius:10px">üëã Smile when greeting</div>
            <div style="padding:10px; background:#fff; border-radius:10px">üëÅÔ∏è Make eye contact</div>
            <div style="padding:10px; background:#fff; border-radius:10px">üó£Ô∏è Speak clearly</div>
          </div>
          <button class="purple" onclick="simulateRolePlay('dialogue1')" style="width:100%; margin-top:12px">Start Role-Play</button>
        </div>
      `;
    },
    onMount: ()=>{
      const lines = [
        "Teacher: Hello, I'm Teacher Smith.",
        "Student: Hi! My name is Alex.",
        "Teacher: Nice to meet you, Alex.",
        "Student: Nice to meet you, too.",
        "Teacher: How old are you?",
        "Student: I'm 11 years old."
      ];
      document.getElementById('dialogue1').appendChild(makeDialogueBox(lines));
    }
  },

  // 5. DIALOGUE 2
  {
    title:"Dialogue 2", stage:"4. Dialogue", rightMeta:"Switch Roles",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('user')} Student-Student Practice</h2>
          <div class="sub">Now you be Student A, then switch to Student B!</div>
          <div id="dialogue2"></div>
          <div class="turn">
            <div class="tTitle">Switch Challenge</div>
            <ul>
              <li>Round 1: Be Student A (blue)</li>
              <li>Round 2: Be Student B (green)</li>
              <li>Complete both = +30pts</li>
            </ul>
          </div>
          <div id="roleSwitchProgress" style="margin-top:12px">
            <div style="display:flex; gap:4px;">
              <div style="flex:1; height:8px; background:var(--blue); border-radius:4px" id="progressA"></div>
              <div style="flex:1; height:8px; background:var(--green); border-radius:4px; opacity:.3" id="progressB"></div>
            </div>
            <div class="mini" style="margin-top:4px">Tap all lines to complete</div>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Expression Logic</h2>
          <div class="sub">How to extend answers:</div>
          <div style="display:grid; gap:8px; font-size:14px">
            <div style="padding:10px; background:rgba(77,150,255,.08); border-radius:10px">
              Q: What's your name?<br>
              A: My name is Alex. <b>I like it because it's short.</b>
            </div>
            <div style="padding:10px; background:rgba(34,197,54,.08); border-radius:10px">
              Q: How old are you?<br>
              A: I'm 11. <b>My birthday is in July.</b>
            </div>
          </div>
          <button class="amber" onclick="extendDialogue()" style="width:100%; margin-top:12px">Practice Extensions</button>
        </div>
      `;
    },
    onMount: ()=>{
      const lines = [
        "Student A: Hi, I'm Lisa. What's your name?",
        "Student B: My name is Tom. Nice to meet you.",
        "Student A: Happy to meet you, too. How old are you?",
        "Student B: I'm 10 years old. What about you?",
        "Student A: I'm 10, too! Let's be friends.",
        "Student B: Great! See you at school."
      ];
      document.getElementById('dialogue2').appendChild(makeDialogueBox(lines));
      
      // Initialize role-switch progress
      window.roleAComplete = false;
      window.roleBComplete = false;
    }
  },

  // 6. VOCAB CHALLENGE
  {
    title:"Vocab Challenge", stage:"5. Practice", rightMeta:"Test & Earn",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('bolt')} Vocabulary Test</h2>
          <div class="sub">Choose the correct answer. Fast and accurate!</div>
          <div id="mcQuiz"></div>
          <div class="challenge-box">
            <h3>Speed Round</h3>
            <div>Answer 10 questions in 60 seconds</div>
            <button class="amber" onclick="startVocabRace()">Start Race</button>
            <div>Score: <span id="quizScore">0</span></div>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Memory Test</h2>
          <div class="sub">Can you recall all 10 words?</div>
          <div class="scene" style="height:150px; display:grid; place-items:center">
            <input type="text" id="memoryTest" placeholder="Type words separated by commas" style="width:80%; padding:12px; border-radius:12px; border:1px solid var(--stroke); font-size:16px">
          </div>
          <button class="primary" onclick="checkMemory()" style="width:100%">Check Memory (+20pts)</button>
          <div id="memoryResult" style="margin-top:8px; font-size:14px"></div>
        </div>
      `;
    },
    onMount: ()=>{
      const quiz = [
        {q:"What's the word for üëã?", options:["wave","point","look"], correct:0},
        {q:"What do you üëÅÔ∏è with?", options:["ear","eye","mouth"], correct:1},
        {q:"What do you listen with?", options:["hand","ear","arm"], correct:1},
        {q:"Greeting response?", options:["Nice to meet you, too","Thank you","Goodbye"], correct:0}
      ];
      
      const host = document.getElementById('mcQuiz');
      quiz.forEach((item,i)=>{
        const qDiv = document.createElement('div');
        qDiv.style.marginBottom = '16px';
        qDiv.innerHTML = `<div class="mini" style="margin-bottom:8px">${item.q}</div>`;
        item.options.forEach((opt,j)=>{
          const btn = document.createElement('button');
          btn.textContent = opt;
          btn.className = 'blue';
          btn.style.margin = '4px';
          btn.onclick = function(){
            if(j === item.correct){
              this.style.background = 'var(--green)';
              this.style.color = '#fff';
              updateScore(10, 'quiz');
              const current = parseInt(document.getElementById('quizScore').textContent);
              document.getElementById('quizScore').textContent = current + 10;
            } else {
              this.style.background = 'var(--pink)';
              this.style.color = '#fff';
            }
            setTimeout(()=>{this.style.background=''; this.style.color='';}, 1000);
          };
          qDiv.appendChild(btn);
        });
        host.appendChild(qDiv);
      });
    }
  },

  // 7. EXPRESSION LOGIC
  {
    title:"Expression Logic", stage:"6. Logic", rightMeta:"Extend & Elaborate",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('bolt')} How to Extend Answers</h2>
          <div class="sub">Don't just answer‚Äîadd details!</div>
          <div style="display:grid; gap:12px; margin-top:12px">
            <div style="padding:16px; background:rgba(77,150,255,.08); border-radius:14px">
              <div class="mini"><b>Level 1:</b> Simple Answer</div>
              <div style="font-size:16px; margin-top:6px">Q: What's your name?<br>A: My name is Alex.</div>
              <button class="blue" onclick="updateScore(5)" style="margin-top:8px">Practice (+5pts)</button>
            </div>
            <div style="padding:16px; background:rgba(34,197,54,.08); border-radius:14px">
              <div class="mini"><b>Level 2:</b> Add Detail</div>
              <div style="font-size:16px; margin-top:6px">Q: What's your name?<br>A: My name is Alex. <b>I'm from Canada.</b></div>
              <button class="primary" onclick="updateScore(10)" style="margin-top:8px">Practice (+10pts)</button>
            </div>
            <div style="padding:16px; background:rgba(251,191,36,.08); border-radius:14px">
              <div class="mini"><b>Level 3:</b> Add Reason</div>
              <div style="font-size:16px; margin-top:6px">Q: What's your name?<br>A: My name is Alex. <b>I like it because it's short.</b></div>
              <button class="amber" onclick="updateScore(15)" style="margin-top:8px">Practice (+15pts)</button>
            </div>
          </div>
          <div class="turn">
            <div class="tTitle">Your Turn: Level Up!</div>
            <ul>
              <li>Start with Level 1</li>
              <li>Build to Level 3</li>
              <li>+15pts per Level 3 answer!</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Logic Connectors</h2>
          <div class="sub">Link your ideas:</div>
          <div class="btnRow" id="connectors"></div>
          <div class="scene" style="height:120px; margin-top:12px">
            <div id="logicPractice" style="padding:12px; background:#fff; border-radius:10px; font-size:14px; color:var(--mut)">
              Tap connectors to build extended sentences
            </div>
          </div>
          <button class="purple" onclick="testLogic()" style="width:100%; margin-top:12px">Test Logic (+20pts)</button>
        </div>
      `;
    },
    onMount: ()=>{
      const connectors = ['and','also','because','so','which','then','when'];
      const host = document.getElementById('connectors');
      connectors.forEach((c,i)=>{
        const btn = document.createElement('button');
        btn.textContent = c;
        btn.className = i%3===0 ? 'blue' : i%3===1 ? 'pink' : 'amber';
        btn.onclick = function(){
          const practice = document.getElementById('logicPractice');
          practice.textContent = practice.textContent === 'Tap connectors to build extended sentences' ? c : practice.textContent + ' ' + c;
          updateScore(2, 'connector');
        };
        host.appendChild(btn);
      });
    }
  },

  // 8. PRACTICE DRILL 1
  {
    title:"Practice Drill 1", stage:"7. Heavy Practice", rightMeta:"Personal Focus",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('user')} Personal Info Drill</h2>
          <div class="sub">Answer all questions with 2 sentences each!</div>
          <div id="personalDrill"></div>
          <div class="turn">
            <div class="tTitle">Drill Tracker</div>
            <ul>
              <li>Answered: <span id="drillCount">0</span> / 5</li>
              <li>Extended answers: <span id="extendedCount">0</span></li>
              <li>+10pts per extended answer</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Quick Fire Round</h2>
          <div class="sub">3 seconds per answer!</div>
          <div class="scene" style="height:120px; display:grid; place-items:center">
            <div style="font-size:36px; color:var(--pink)" id="quickFireQ">Ready?</div>
          </div>
          <button class="primary" onclick="startQuickFire()" style="width:100%">Start Quick Fire (+30pts)</button>
          <div id="quickFireResult" style="margin-top:8px; font-size:14px; color:var(--mut)"></div>
        </div>
      `;
    },
    onMount: ()=>{
      const questions = [
        "What's your name?",
        "How old are you?",
        "Where are you from?",
        "Who is your best friend?",
        "What do you like doing?"
      ];
      
      const host = document.getElementById('personalDrill');
      let answered = 0, extended = 0;
      
      questions.forEach(q=>{
        const qDiv = document.createElement('div');
        qDiv.style.marginBottom = '12px';
        qDiv.innerHTML = `
          <div class="mini" style="margin-bottom:8px">${q}</div>
          <input type="text" placeholder="Type your 2-sentence answer" style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--stroke)">
          <button class="blue" style="margin-top:6px">Submit Answer</button>
        `;
        qDiv.querySelector('button').onclick = function(){
          answered++;
          document.getElementById('drillCount').textContent = answered;
          
          // Simulate checking for extended answer
          if(Math.random() > 0.4){
            extended++;
            document.getElementById('extendedCount').textContent = extended;
            updateScore(10, 'extended');
            this.textContent = 'Great! +10pts';
            this.style.background = 'var(--green)';
          } else {
            this.textContent = 'Try again';
            this.style.background = 'var(--pink)';
          }
          this.disabled = true;
        };
        host.appendChild(qDiv);
      });
    }
  },

  // 9. PRACTICE DRILL 2
  {
    title:"Practice Drill 2", stage:"7. Heavy Practice", rightMeta:"School Focus",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('school')} School Life Drill</h2>
          <div class="sub">Talk about school with details!</div>
          <div class="grid6" id="schoolTiles"></div>
          <div class="turn">
            <div class="tTitle">School Challenge</div>
            <ul>
              <li>Tap 5 cards ‚Üí speak 2 sentences each</li>
              <li>Use "because" at least 3 times</li>
              <li>Complete = +50pts</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>School Description</h2>
          <div class="sub">Describe your school in 30 seconds:</div>
          <div id="schoolDesc"></div>
          <button class="primary" onclick="practiceSchoolDesc()" style="width:100%; margin-top:12px">Describe School (+20pts)</button>
        </div>
      `;
    },
    onMount: ()=>{
      const schoolItems = [
        {w:"teacher", q:"Describe your teacher", a:"My teacher is friendly because..."},
        {w:"subject", q:"Favourite subject?", a:"My favourite subject is English because..."},
        {w:"classroom", q:"Your classroom?", a:"My classroom is big and clean."},
        {w:"friend", q:"Classmates?", a:"I have many friends at school."},
        {w:"uniform", q:"Uniform?", a:"I wear a blue uniform."},
        {w:"playground", q:"Playground?", a:"I play football at the playground."}
      ];
      
      const host = document.getElementById('schoolTiles');
      let tapped = 0;
      schoolItems.forEach(item=>{
        item.ic = 'school';
        const tile = makeTileCard(item, 'SCHOOL');
        tile.addEventListener('click', ()=>{
          if(!tile.classList.contains('revealed')){
            tapped++;
            if(tapped >= 5){
              updateScore(50, 'schoolChallenge');
              alert('School Challenge Complete! +50pts');
            }
          }
        }, {once: true});
        host.appendChild(tile);
      });
      
      // School description practice
      const descHost = document.getElementById('schoolDesc');
      const prompts = [
        "Big/Friendly/Modern",
        "Playground/Library/Classroom",
        "Teachers are helpful/strict/interesting",
        "I like it because..."
      ];
      prompts.forEach(p=>{
        const btn = document.createElement('button');
        btn.textContent = p;
        btn.className = 'amber';
        btn.style.margin = '4px';
        btn.onclick = ()=>updateScore(5, 'schoolDesc');
        descHost.appendChild(btn);
      });
    }
  },

  // 10. HIGH-SCORING EXPRESSIONS
  {
    title:"High-Scoring Expressions", stage:"8. Advanced", rightMeta:"Score Higher!",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>${svgIcon('trophy')} Express Like a Pro</h2>
          <div class="sub">Use these for KET Speaking Part 1:</div>
          <div style="display:grid; gap:12px;">
            <div style="padding:16px; background:rgba(251,191,36,.08); border-radius:14px">
              <div class="mini">Instead of: "I like English"</div>
              <div style="font-size:16px; margin-top:6px; font-weight:500">"My favourite subject is English because it's useful and interesting."</div>
              <button class="amber" onclick="practiceHighScore(1)" style="margin-top:8px">Practice (+15pts)</button>
            </div>
            <div style="padding:16px; background:rgba(139,92,246,.08); border-radius:14px">
              <div class="mini">Instead of: "I have friends"</div>
              <div style="font-size:16px; margin-top:6px; font-weight:500">"I get along with my classmates because they are friendly and helpful."</div>
              <button class="purple" onclick="practiceHighScore(2)" style="margin-top:8px">Practice (+15pts)</button>
            </div>
            <div style="padding:16px; background:rgba(34,197,54,.08); border-radius:14px">
              <div class="mini">Instead of: "I go to school"</div>
              <div style="font-size:16px; margin-top:6px; font-weight:500">"I study at Sunshine School from Monday to Friday, and I really enjoy it."</div>
              <button class="green" onclick="practiceHighScore(3)" style="margin-top:8px">Practice (+15pts)</button>
            </div>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>Complex Sentences</h2>
          <div class="sub">Build sentences with:</div>
          <div class="btnRow" id="complexParts"></div>
          <div id="complexResult" class="scene" style="height:100px; margin-top:12px; display:grid; place-items:center; font-size:16px; color:var(--mut)">
            Tap buttons to build complex sentences
          </div>
          <button class="primary" onclick="testComplexSentence()" style="width:100%; margin-top:12px">Test Sentence (+20pts)</button>
        </div>
      `;
    },
    onMount: ()=>{
      const parts = ['My favourite','subject is','English','because it is','useful','and also','interesting','which helps me','study better'];
      const host = document.getElementById('complexParts');
      parts.forEach((p,i)=>{
        const btn = document.createElement('button');
        btn.textContent = p;
        btn.className = i%3===0 ? 'blue' : i%3===1 ? 'pink' : 'amber';
        btn.onclick = function(){
          const result = document.getElementById('complexResult');
          const currentText = result.textContent;
          result.textContent = currentText === 'Tap buttons to build complex sentences' ? p : currentText + ' ' + p;
          updateScore(2, 'complex');
        };
        host.appendChild(btn);
      });
    }
  },

  // 11. FINAL SIMULATION
  {
    title:"Final Simulation", stage:"9. Assessment", one:true,
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>üìù Final KET Speaking Test</h1>
          <div class="sub">Complete all tasks to earn your certificate!</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px">
            <div style="padding:16px; background:rgba(77,150,255,.08); border-radius:14px">
              <div class="mini">Task 1: Personal Info</div>
              <div style="font-size:14px; margin-top:6px">5 questions</div>
              <div id="task1Status">‚è≥ Not started</div>
            </div>
            <div style="padding:16px; background:rgba(34,197,54,.08); border-radius:14px">
              <div class="mini">Task 2: School Life</div>
              <div style="font-size:14px; margin-top:6px">5 questions</div>
              <div id="task2Status">‚è≥ Not started</div>
            </div>
            <div style="padding:16px; background:rgba(251,191,36,.08); border-radius:14px; grid-column:1/-1">
              <div class="mini">Task 3: 40-second Speech</div>
              <div id="task3Status">‚è≥ Not started</div>
            </div>
          </div>
          <div class="turn" style="margin-top:16px">
            <div class="tTitle">üé§ Start Assessment</div>
            <ul>
              <li>Complete all tasks for final score</li>
              <li>800+ points = Gold Certificate</li>
              <li>600+ points = Silver Certificate</li>
            </ul>
          </div>
          <div class="btnRow" style="justify-content:center; margin-top:16px">
            <button class="primary" onclick="startFinalAssessment()" style="padding:16px 32px; font-size:18px">Start Final Test</button>
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      window.assessmentProgress = {task1: false, task2: false, task3: false};
    }
  },

  // 12. CERTIFICATE
  {
    title:"Certificate", stage:"10. Complete", one:true,
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>üéâ Congratulations!</h1>
          <div class="scene" style="height:250px; background:linear-gradient(135deg, rgba(251,191,36,.15), rgba(139,92,246,.15)); display:grid; place-items:center; border-radius:20px">
            <div style="text-align:center">
              <div style="font-size:72px">üèÜ</div>
              <div style="font-size:24px; color:var(--purple); margin-top:12px" id="certificateType">Gold Certificate</div>
              <div style="font-size:36px; color:var(--amber); margin-top:8px" id="finalScoreDisplay">850pts</div>
            </div>
          </div>
          <div class="challenge-box">
            <h3>Your Achievements</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:14px">
              <div>‚úì Vocabulary Master: <span id="vocabScore">--</span></div>
              <div>‚úì Dialogue Expert: <span id="dialogueScore">--</span></div>
              <div>‚úì Logic Builder: <span id="logicScore">--</span></div>
              <div>‚úì Speaking Pro: <span id="speakingScore">--</span></div>
            </div>
          </div>
          <div class="turn">
            <div class="tTitle">Next Steps</div>
            <ul>
              <li>Review weak areas (see feedback)</li>
              <li>Practice with friends</li>
              <li>Try Unit 2: Daily Routines</li>
            </ul>
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      // Calculate and display final scores
      document.getElementById('finalScoreDisplay').textContent = userScore + 'pts';
      
      let certificate = 'Bronze Certificate';
      if(userScore >= 800) certificate = 'Gold Certificate';
      else if(userScore >= 600) certificate = 'Silver Certificate';
      document.getElementById('certificateType').textContent = certificate;
      
      // Break down scores (simulated)
      const vocabScore = Math.min(150, Math.floor(userScore * 0.3));
      const dialogueScore = Math.min(150, Math.floor(userScore * 0.25));
      const logicScore = Math.min(150, Math.floor(userScore * 0.25));
      const speakingScore = Math.min(150, Math.floor(userScore * 0.2));
      
      document.getElementById('vocabScore').textContent = vocabScore + 'pts';
      document.getElementById('dialogueScore').textContent = dialogueScore + 'pts';
      document.getElementById('logicScore').textContent = logicScore + 'pts';
      document.getElementById('speakingScore').textContent = speakingScore + 'pts';
    }
  }
];

/* =========================
   Interactive Functions (Complete)
   ========================= */
function startVocabRace(){
  let time = 60, score = 0;
  const timer = setInterval(()=>{
    time--;
    document.getElementById('raceScore').textContent = `Time: ${time}s | Score: ${score}`;
    if(time <= 0){
      clearInterval(timer);
      alert(`Race finished! Final score: ${score}`);
      updateScore(score, 'race');
    }
  }, 1000);
  
  // Enable scoring on power words
  document.querySelectorAll('#powerWords button').forEach(btn=>{
    btn.addEventListener('click', ()=>{score += 5;}, {once: true});
  });
}

function checkMemory(){
  const input = document.getElementById('memoryTest').value.toLowerCase();
  const words = ['name','friend','wave','point','look','hand','arm','eye','ear','mouth'];
  const userWords = input.split(',').map(w=>w.trim());
  const correct = userWords.filter(w=>words.includes(w)).length;
  
  const resultDiv = document.getElementById('memoryResult');
  resultDiv.innerHTML = `Correct: ${correct} / 10 words. +${correct*2}pts`;
  updateScore(correct*2, 'memory');
}

function practiceHighScore(level){
  alert(`High-Score Level ${level}: Practice saying the full sentence 3 times with expression!`);
  updateScore(15, 'highScore'+level);
}

function testLogic(){
  const practice = document.getElementById('logicPractice');
  if(practice.textContent.split(' ').length > 5){
    alert('Great logic chain! +20pts');
    updateScore(20, 'logic');
  } else {
    alert('Add more connectors for better logic!');
  }
}

function practiceSchoolDesc(){
  alert('Practice describing your school for 30 seconds. Use 2 power words and 1 because!');
  updateScore(20, 'schoolDesc');
}

function startQuickFire(){
  const questions = ["Name?","Age?","City?","Hobby?","School?"];
  let qIndex = 0;
  const qDiv = document.getElementById('quickFireQ');
  
  const interval = setInterval(()=>{
    qDiv.textContent = questions[qIndex];
    qIndex++;
    if(qIndex >= questions.length){
      clearInterval(interval);
      document.getElementById('quickFireResult').textContent = 'Great! Quick responses earn +30pts';
      updateScore(30, 'quickFire');
    }
  }, 3000);
  
  document.getElementById('quickFireResult').textContent = 'Answer each question immediately!';
}

function startFinalAssessment(){
  alert('Starting final assessment! Complete all tasks to earn big points.');
  
  // Simulate task completion with delays
  setTimeout(()=>{
    document.getElementById('task1Status').innerHTML = '‚úÖ Complete +150pts';
    window.assessmentProgress.task1 = true;
    updateScore(150, 'task1');
  }, 2000);
  
  setTimeout(()=>{
    document.getElementById('task2Status').innerHTML = '‚úÖ Complete +150pts';
    window.assessmentProgress.task2 = true;
    updateScore(150, 'task2');
  }, 4000);
  
  setTimeout(()=>{
    document.getElementById('task3Status').innerHTML = '‚úÖ Complete +200pts';
    window.assessmentProgress.task3 = true;
    updateScore(200, 'task3');
    
    // Auto-advance to certificate after completion
    setTimeout(()=>show(11), 1000);
  }, 6000);
}

function simulateRolePlay(id){
  alert('Role-Play Mode: Speak each line aloud. Tap when finished!');
  updateScore(10, 'roleplay');
}

function extendDialogue(){
  alert('Practice adding details: "My name is Tom" ‚Üí "My name is Tom, I am 11 years old"');
  updateScore(10, 'extension');
}

/* =========================
   Slide Rendering System (Complete)
   ========================= */
function slideShell({title, stage, rightMeta, one=false}){
  const s = document.createElement('section');
  s.className = 'slide';
  s.dataset.title = title;
  
  const header = document.createElement('div');
  header.className = 'header';
  header.innerHTML = `
    <div class="badge"><span class="dot"></span> ${stage}</div>
    <div class="meta">
      <span class="pill" data-count>1 / ${slides.length}</span>
      ${rightMeta ? `<span class="pill">${rightMeta}</span>` : ``}
    </div>
  `;
  
  const wrap = document.createElement('div');
  wrap.className = 'wrap' + (one ? ' one' : '');
  
  s.appendChild(header);
  s.appendChild(wrap);
  return {s, wrap};
}

const deck = document.getElementById('deck');
const slides = [];
slideDefs.forEach(def=>{
  const {s, wrap} = slideShell({
    title: def.title,
    stage: def.stage,
    rightMeta: def.rightMeta,
    one: !!def.one
  });
  
  if(def.one){
    const slot = document.createElement('div'); slot.className = 'slot';
    wrap.appendChild(slot);
    def.left(slot);
  } else {
    const left = document.createElement('div'); left.className = 'slot';
    const right = document.createElement('div'); right.className = 'slot';
    wrap.appendChild(left); wrap.appendChild(right);
    def.left(left);
    if(def.right) def.right(right);
  }
  
  deck.appendChild(s);
  slides.push({el:s, onMount:def.onMount||null, title:def.title});
});

// Bottom Navigation
const nav = document.createElement('div');
nav.id = "nav";
nav.innerHTML = `
  <button class="navBtn secondary" id="prev">‚¨Ö Prev</button>
  <div class="center">
    <span id="navTitle">Lesson Start</span>
    <div class="progress" aria-label="progress"><div class="bar" id="bar"></div></div>
    <span id="count">1 / ${slides.length}</span>
  </div>
  <button class="navBtn" id="next">Next ‚û°</button>
`;
deck.appendChild(nav);

let idx = 0;
function show(i){
  idx = Math.max(0, Math.min(slides.length-1, i));
  slides.forEach((s,k)=>s.el.classList.toggle('active', k===idx));
  
  const c = slides[idx].el.querySelector('[data-count]');
  if(c) c.textContent = `${idx+1} / ${slides.length}`;
  
  document.getElementById('navTitle').textContent = slides[idx].title;
  document.getElementById('count').textContent = `${idx+1} / ${slides.length}`;
  document.getElementById('prev').disabled = idx===0;
  document.getElementById('next').disabled = idx===slides.length-1;
  document.getElementById('bar').style.width = ((idx+1)/slides.length*100) + '%';
  
  if(slides[idx].onMount) slides[idx].onMount();
}

document.getElementById('prev').onclick = ()=>show(idx-1);
document.getElementById('next').onclick = ()=>show(idx+1);

// Keyboard Controls
window.addEventListener('keydown', e=>{
  const k = e.key.toLowerCase();
  if(k==='arrowright' || k===' ') show(idx+1);
  if(k==='arrowleft') show(idx-1);
});

// Swipe Support
let sx=null;
window.addEventListener('touchstart', e=>sx=e.changedTouches[0].clientX, {passive:true});
window.addEventListener('touchend', e=>{
  if(sx===null) return;
  const dx = e.changedTouches[0].clientX - sx;
  if(dx < -50) show(idx+1);
  if(dx > 50) show(idx-1);
  sx=null;
},{passive:true});

// Initialize
show(0);
</script>
</body>
</html>