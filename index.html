<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KET Speaking 1v1 Â· T1 ä¸ªäººä¸å­¦æ ¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰</title>
  <style>
    :root{
      --ink:#1E2A44;
      --mut:#5A6A86;
      --bg:#F6FBFF;
      --card:#FFFFFF;
      --stroke:rgba(30,42,68,.12);
      --shadow:0 18px 40px rgba(30,42,68,.10);
      --blue:#4D96FF;
      --pink:#FB7185;
      --green:#22C55E;
      --purple:#8B5CF6;
      --amber:#FBBF24;
      --radius:24px;
      --pad:52px;
      --padM:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color:var(--ink);
      overflow:hidden;
      background:linear-gradient(120deg, var(--bg), #FFF6FB);
    }
    /* éš¾åº¦æ¨¡å¼åˆ‡æ¢ */
    .mode-switch{
      position:fixed; top:20px; right:20px; z-index:1000;
      display:flex; gap:8px; align-items:center;
      background:rgba(255,255,255,.9); padding:8px; border-radius:999px;
      border:1px solid var(--stroke); box-shadow:var(--shadow);
    }
    .mode-switch button{
      padding:8px 16px; border-radius:999px; border:none; cursor:pointer;
      font-size:13px; background:transparent;
    }
    .mode-switch .active{
      background:var(--blue); color:#fff;
    }

    #deck{height:100vh;width:100vw;position:relative}
    .slide{
      position:absolute; inset:0;
      padding:var(--pad) var(--pad) 92px;
      display:none; background:var(--bg);
    }
    .slide.active{display:block}
    .slide[data-level="pro"] .basic-hint{display:none}
    .slide[data-level="basic"] .pro-hint{display:none}
    
    @media (max-width: 980px){
      .slide{padding:46px var(--padM) 92px}
      .mode-switch{top:10px; right:10px}
    }

    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:14px; padding-bottom:10px;
      border-bottom:2px solid rgba(77,150,255,.15);
    }
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:999px;
      background:var(--card); border:1px solid var(--stroke);
      box-shadow:var(--shadow); font-size:14px; color:var(--mut);
    }
    .badge .dot{
      width:10px; height:10px; border-radius:50%;
      background:linear-gradient(135deg, var(--blue), var(--purple));
    }
    .micro-target{
      font-size:13px; color:var(--green); font-weight:600; margin-top:6px;
    }

    .wrap{
      height:calc(100vh - 92px - 46px); display:grid;
      grid-template-columns:1fr 1fr; gap:16px;
    }
    .wrap.one{grid-template-columns:1fr}
    @media (max-width: 980px){.wrap{grid-template-columns:1fr}}

    .card{
      background:var(--card); border:1px solid var(--stroke);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:20px; overflow:auto; position:relative;
    }
    .card.soft{background:linear-gradient(180deg, rgba(244,248,255,.92), rgba(255,255,255,.92))}
    
    h1{margin:0 0 10px; font-size:36px; letter-spacing:.2px}
    h2{margin:0 0 10px; font-size:26px; display:flex; align-items:center; gap:10px}
    .sub{color:var(--mut); font-size:16px; line-height:1.55; margin-bottom:12px}
    .big{font-size:18px; line-height:1.65}
    .mini{font-size:14px; color:var(--mut); line-height:1.55}

    .turn{
      margin-top:16px; padding:14px; border-radius:18px;
      border:2px dashed rgba(77,150,255,.24); background:rgba(255,255,255,.88);
    }
    .turn .tTitle{
      display:flex; align-items:center; gap:10px;
      font-size:16px; color:var(--ink); margin-bottom:8px;
      user-select:none; font-weight:600;
    }
    .turn ul{margin:8px 0 0; padding-left:18px; color:var(--mut); line-height:1.6}
    .turn li{margin-bottom:6px}

    .grid6{
      display:grid; grid-template-columns:repeat(3, 1fr);
      gap:12px; margin-top:12px;
    }
    @media (max-width: 980px){.grid6{grid-template-columns:repeat(2, 1fr)}}

    .tile{
      border-radius:18px; border:1px solid var(--stroke);
      background:var(--card); box-shadow:0 12px 26px rgba(30,42,68,.08);
      padding:14px; cursor:pointer; user-select:none;
      transition:all .2s ease; min-height:110px; position:relative;
    }
    .tile:hover{transform:translateY(-2px)}
    .tile:active{transform:translateY(1px)}
    .tile.speaking{background:rgba(77,150,255,.1); border-color:var(--blue)}
    .tile.revealed{outline:3px solid rgba(77,150,255,.2)}
    
    .tag{
      position:absolute; top:10px; right:10px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--stroke); background:rgba(255,255,255,.85);
      color:var(--mut);
    }
    .w{display:flex; align-items:flex-start; gap:10px}
    .icon{width:28px; height:28px; flex:0 0 auto}
    .word{font-size:18px; color:var(--ink); font-weight:500}
    .hint{margin-top:8px; color:var(--mut); font-size:14px; line-height:1.5}
    
    .tile .front{opacity:1; transition:opacity .3s}
    .tile .back{display:none; opacity:0}
    .tile.revealed .front{display:none; opacity:0}
    .tile.revealed .back{display:block; opacity:1}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      appearance:none; border:none; cursor:pointer;
      padding:12px 14px; border-radius:14px; font-size:14px;
      background:var(--card); border:1px solid var(--stroke);
      color:var(--ink); box-shadow:0 10px 22px rgba(30,42,68,.08);
      transition:all .15s ease; position:relative;
    }
    button.primary{background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.22)}
    button.blue{background:rgba(77,150,255,.14); border-color:rgba(77,150,255,.22)}
    button.pink{background:rgba(251,113,133,.14); border-color:rgba(251,113,133,.22)}
    button.amber{background:rgba(251,191,36,.14); border-color:rgba(251,191,36,.22)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.45; cursor:not-allowed}

    .mini-timer{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:12px;
      background:var(--card); border:1px solid var(--stroke);
      font-size:13px; color:var(--mut);
    }
    .mini-ring{
      width:20px; height:20px; border-radius:50%;
      border:2px solid var(--stroke);
      border-top-color:var(--blue);
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    #nav{
      position:absolute; left:18px; right:18px; bottom:14px; height:54px;
      border-radius:18px; background:rgba(255,255,255,.86);
      border:1px solid var(--stroke); box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; gap:10px; user-select:none;
    }
    .navBtn{
      padding:10px 12px; border-radius:14px; cursor:pointer;
      font-size:14px; white-space:nowrap;
      background:rgba(77,150,255,.12); border:1px solid rgba(77,150,255,.2);
    }
    .navBtn.secondary{
      background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.2);
    }
    .navBtn:disabled{opacity:.45; cursor:not-allowed}
    .center{
      flex:1; display:flex; align-items:center; justify-content:center; gap:10px;
      min-width:260px; color:var(--mut); font-size:14px;
    }
    .progress{
      height:8px; width:220px; background:rgba(30,42,68,.10);
      border-radius:999px; overflow:hidden; border:1px solid rgba(30,42,68,.08);
    }
    .bar{
      height:100%; width:0%; background:linear-gradient(135deg, var(--blue), var(--purple));
      border-radius:999px; transition:width .2s ease;
    }

    /* æ•™å¸ˆé¢æ¿ */
    #teacherPanel{
      position:fixed; top:0; right:0; width:320px; height:100vh;
      background:var(--card); border-left:1px solid var(--stroke);
      box-shadow:-8px 0 24px rgba(30,42,68,.1);
      transform:translateX(100%); transition:transform .3s ease;
      z-index:1001; display:flex; flex-direction:column;
    }
    #teacherPanel.open{transform:translateX(0)}
    .panel-header{
      padding:16px; border-bottom:1px solid var(--stroke);
      display:flex; justify-content:space-between; align-items:center;
    }
    .panel-content{
      flex:1; overflow:auto; padding:16px; display:grid; gap:12px;
    }
    .error-card{
      background:rgba(251,113,133,.08); border:1px solid rgba(251,113,133,.2);
      border-radius:14px; padding:12px;
    }
    .error-card h4{margin:0 0 6px; color:var(--ink)}
    .error-card p{margin:0; font-size:13px; color:var(--mut)}
    .heat-bar{
      height:6px; background:rgba(77,150,255,.1); border-radius:3px; margin-top:6px;
      overflow:hidden;
    }
    .heat-fill{
      height:100%; background:var(--blue); transition:width .3s ease;
    }
  </style>
</head>

<body>
<!-- éš¾åº¦æ¨¡å¼åˆ‡æ¢ -->
<div class="mode-switch">
  <span>æ¨¡å¼:</span>
  <button id="modeBasic" class="active" onclick="setMode('basic')">åŸºç¡€</button>
  <button id="modePro" onclick="setMode('pro')">è¿›é˜¶</button>
  <button onclick="toggleTeacher()" style="margin-left:10px; background:var(--purple); color:#fff">æ•™å¸ˆ</button>
</div>

<div id="deck"></div>

<!-- æ•™å¸ˆç›‘æ§é¢æ¿ -->
<div id="teacherPanel">
  <div class="panel-header">
    <h3>æ•™å¸ˆç›‘æ§</h3>
    <button onclick="toggleTeacher()">å…³é—­</button>
  </div>
  <div class="panel-content">
    <div class="card">
      <h4>ç­çº§è¿›åº¦</h4>
      <div id="classProgress"></div>
    </div>
    <div class="card">
      <h4>é«˜é¢‘é”™è¯¯</h4>
      <div id="errorStats"></div>
    </div>
    <div class="card">
      <h4>å®æ—¶ç­”é¢˜</h4>
      <div id="liveAnswers"></div>
    </div>
  </div>
</div>

<!-- å¹»ç¯ç‰‡é€‰æ‹©å™¨ -->
<div id="picker" aria-hidden="true">
  <div class="pickerPanel">
    <div class="pickerTop">
      <h3>è·³è½¬åˆ°å¹»ç¯ç‰‡</h3>
      <button onclick="togglePicker(false)">å…³é—­</button>
    </div>
    <div class="list" id="pickerList"></div>
  </div>
</div>

<script>
/* =========================
   SVGå›¾æ ‡åº“
   ========================= */
function svgIcon(type){
  const s = 'stroke="rgba(30,42,68,.35)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"';
  const icons = {
    tag: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M4 7.5C4 6.1 5.1 5 6.5 5h11C19 5 20 6.1 20 7.5v9C20 17.9 18.9 19 17.5 19h-11C5.1 19 4 17.9 4 16.5v-9Z"/><path d="M7 9h10" stroke="#4D96FF" stroke-width="2.2"/><path d="M7 12h7" stroke="#FB7185" stroke-width="2.2"/></svg>`,
    clock: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M12 22a10 10 0 1 0-10-10 10 10 0 0 0 10 10Z"/><path d="M12 6v6l4 2" stroke="#4D96FF" stroke-width="2.2"/></svg>`,
    pin: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M12 21s7-4.4 7-10.2A7 7 0 0 0 5 10.8C5 16.6 12 21 12 21Z"/><circle cx="12" cy="11" r="2.6" fill="#22C55E" opacity=".35"/></svg>`,
    home: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M3 11l9-7 9 7"/><path ${s} d="M5 10v10h14V10"/><path d="M10 20v-6h4v6" stroke="#FB7185" stroke-width="2.2"/></svg>`,
    school: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M4 10.5 12 6l8 4.5v8.2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8.2Z"/><path d="M9 20v-6h6v6" stroke="#4D96FF" stroke-width="2.2"/></svg>`,
    book: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M6 4h10a2 2 0 0 1 2 2v14H8a2 2 0 0 0-2 2V4Z"/><path d="M8 7h8" stroke="#22C55E" stroke-width="2.2"/></svg>`,
    teacher: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z"/><path ${s} d="M4 20a8 8 0 0 1 16 0"/></svg>`,
    group: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M16 11a3 3 0 1 0-3-3 3 3 0 0 0 3 3Z"/><path ${s} d="M8 12a3 3 0 1 0-3-3 3 3 0 0 0 3 3Z"/><path ${s} d="M2 20a6 6 0 0 1 10 0"/><path ${s} d="M12 20a6 6 0 0 1 10 0"/></svg>`,
    bolt: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M13 2 4 14h7l-1 8 10-12h-7Z"/><path d="M11 14h7" stroke="#FBBF24" stroke-width="2.2"/></svg>`,
    star: `<svg class="icon" viewBox="0 0 24 24"><path ${s} d="M12 3l3 6 6 .9-4.5 4.3 1.1 6.3L12 18.8 5.4 20.5 6.5 14 2 9.7 8 8.9 12 3Z" fill="rgba(251,191,36,.25)"/></svg>`
  };
  return icons[type] || `<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="rgba(77,150,255,.18)"/></svg>`;
}

/* =========================
   æ ¸å¿ƒæ•°æ®ï¼ˆç»“æ„åŒ–JSONï¼‰
   ========================= */
const curriculum = {
  powerWords: ["friendly","helpful","strict","interesting","boring","difficult","easy","useful","popular","comfortable"],
  topics: {
    personal: [
      {w:"name", q:"What's your name?", a:"My name is ___."},
      {w:"age", q:"How old are you?", a:"I'm ___ years old."},
      {w:"live in", q:"Where do you live?", a:"I live in ___."},
      {w:"live with", q:"Who do you live with?", a:"I live with ___."},
      {w:"come from", q:"Where are you from?", a:"I come from ___."},
      {w:"hobby", q:"What's your hobby?", a:"My hobby is ___."}
    ],
    school: [
      {w:"student", q:"Are you a student?", a:"Yes, I'm a student."},
      {w:"school", q:"Do you like your school?", a:"My school is ___."},
      {w:"subject", q:"What subjects do you study?", a:"I study English, maths and ___."},
      {w:"teacher", q:"What's your teacher like?", a:"My teacher is ___."},
      {w:"after school", q:"What do you do after school?", a:"After school, I ___."},
      {w:"uniform", q:"Do you wear a uniform?", a:"Yes, I wear a uniform."}
    ]
  },
  chunks: [
    {w:"my favourite subject", a:"My favourite subject is ___ because ___."},
    {w:"after-school club", a:"I go to an after-school club."},
    {w:"get along with", a:"I get along with my classmates."}
  ],
  frames: [
    "I study at ___ School.",
    "My favourite subject is ___ because ___.",
    "I get along with my classmates."
  ],
  examQs: {
    personal: ["What's your name?","How old are you?","Where do you live?","Who do you live with?","What's your hobby?"],
    school: ["What school do you go to?","What's your favourite subject? Why?","Do you like your school?","What do you do after school?"]
  },
  errors: [
    {w:"I live with Beijing.", type:"ä»‹è¯é”™è¯¯", a:"I live in Beijing."},
    {w:"I study in Sunshine School.", type:"ä»‹è¯é”™è¯¯", a:"I study at Sunshine School."},
    {w:"My mother...he...", type:"äººç§°é”™è¯¯", a:"My mother...she..."},
    {w:"He like football.", type:"ä¸‰å•é”™è¯¯", a:"He likes football."}
  ]
};

/* =========================
   å·¥å…·å‡½æ•°
   ========================= */
function makeTileCard(item, tag, level = 'basic'){
  const tile = document.createElement('div');
  tile.className = 'tile';
  tile.dataset.level = level;
  tile.innerHTML = `
    <div class="tag">${tag}</div>
    <div class="front">
      <div class="w">${svgIcon(item.ic || 'book')}
        <div><div class="word">${item.w}</div>
        ${level === 'basic' ? `<div class="hint basic-hint">ç‚¹å‡»å¬å‘éŸ³</div>` : ''}
        <div class="hint pro-hint">è¯´å‡º2ä¸ªå¥å­</div></div>
      </div>
    </div>
    <div class="back">
      <div class="mini"><b>${item.q || 'Say it'}</b></div>
      <div class="hint">${item.a}</div>
      ${level === 'basic' ? `<div class="hint" style="margin-top:6px; color:var(--green)">+ ç»†èŠ‚è¡¥å……</div>` : ''}
    </div>
  `;
  
  // äº¤äº’ï¼šæ¨¡æ‹ŸTTS+ç­”æ¡ˆæ˜¾ç¤º
  tile.addEventListener('click', function(){
    if(this.classList.contains('speaking')) return;
    
    // ç¬¬ä¸€æ­¥ï¼šè§†è§‰åé¦ˆ+æ¨¡æ‹Ÿå‘éŸ³
    this.classList.add('speaking');
    setTimeout(() => {
      this.classList.remove('speaking');
      this.classList.add('revealed');
      // æ¨¡æ‹Ÿæ•™å¸ˆç›‘æ§æ•°æ®
      recordStudentAction('speak', item.w);
    }, 1200);
  });
  
  return tile;
}

function makeErrorCard(error){
  const card = document.createElement('div');
  card.className = 'tile';
  card.innerHTML = `
    <div class="tag" style="background:rgba(251,113,133,.15)">Fix</div>
    <div class="front">
      <div class="w">${svgIcon('bolt')}
        <div><div class="word" style="color:var(--pink)">${error.w}</div>
        <div class="hint" style="color:var(--pink)">${error.type}</div></div>
      </div>
    </div>
    <div class="back">
      <div class="hint" style="color:var(--green)">${error.a}</div>
    </div>
  `;
  card.addEventListener('click', () => {
    card.classList.toggle('revealed');
    recordStudentAction('fix', error.type);
  });
  return card;
}

function recordStudentAction(action, detail){
  // æ¨¡æ‹Ÿæ•°æ®æ”¶é›†
  const data = JSON.parse(localStorage.getItem('ketSpeakingData') || '{}');
  data[detail] = (data[detail] || 0) + 1;
  localStorage.setItem('ketSpeakingData', JSON.stringify(data));
  updateTeacherPanel();
}

/* =========================
   å¹»ç¯ç‰‡å®šä¹‰ï¼ˆæŒ‰è¯é¢˜èšç±»ï¼‰
   ========================= */
const slideDefs = [
  // 1. å°é¢é¡µï¼ˆå«KETæ ‡å‡†ï¼‰
  {
    title:"æ¬¢è¿", stage:"T1 Â· ä¸ªäººä¸å­¦æ ¡", one:true,
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>ä¸ªäººä»‹ç»ä¸å­¦æ ¡ç”Ÿæ´»</h1>
          <div class="sub">KETå£è¯­Part 1 Â· 1å¯¹1è®­ç»ƒ</div>
          <div class="scene" style="height:200px; background:linear-gradient(135deg, rgba(77,150,255,.1), rgba(251,113,133,.08)); border-radius:20px; display:grid; place-items:center; font-size:18px; color:var(--mut)">
            <div style="text-align:center">
              <div style="font-size:24px; color:var(--ink); margin-bottom:10px">ğŸ¯ è¯„åˆ†æ ‡å‡†</div>
              <div>âœ“ 6+ å¥å­ | âœ“ 40-50ç§’ | âœ“ 2ä¸ªbecause | âœ“ 2ä¸ªé«˜çº§è¯</div>
            </div>
          </div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ ä½ çš„ä»»åŠ¡</div>
            <ul>
              <li>ç”¨è‹±è¯­ä»‹ç»è‡ªå·±ï¼ˆå§“åã€å¹´é¾„ã€åŸå¸‚ï¼‰</li>
              <li>æè¿°ä½ çš„å­¦æ ¡å’Œè€å¸ˆ</li>
              <li>è¯´æ˜å–œæ¬¢çš„ç§‘ç›®åŠåŸå› </li>
            </ul>
          </div>
          <div class="micro-target">å¾®ç›®æ ‡ï¼šæ˜ç¡®è€ƒè¯•è¦æ±‚</div>
        </div>
      `;
    }
  },

  // 2. è¯­éŸ³æ¨¡ä»¿ï¼ˆå¾®è®¡æ—¶å™¨ï¼‰
  {
    title:"è¯­éŸ³æ¨¡ä»¿", stage:"çƒ­èº«", rightMeta:"3ç§’å‡†å¤‡+15ç§’ç­”é¢˜",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>âš¡ è·Ÿæˆ‘è¯»</h2>
          <div class="sub">å…ˆå¬ç¤ºèŒƒï¼Œç„¶åæ¨¡ä»¿å¹¶æ”¹ç¼–</div>
          <div class="scene" style="padding:20px; font-size:18px; background:rgba(77,150,255,.08)">
            <div style="background:#fff; padding:16px; border-radius:14px; margin-bottom:12px">
              My name is Alex. I'm 12 years old.<br>
              I live in Beijing with my parents.
            </div>
            <div class="mini" style="display:flex; align-items:center; gap:8px">
              <span>å‡†å¤‡æ—¶é—´ï¼š</span>
              <div class="mini-timer"><div class="mini-ring"></div> <span id="prepTimer">3</span>ç§’</div>
            </div>
          </div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ ä½ çš„ç‰ˆæœ¬</div>
            <ul>
              <li>æ›¿æ¢åˆ’çº¿éƒ¨åˆ†ä¸ºä½ çš„ä¿¡æ¯</li>
              <li>åŸºç¡€æ¨¡å¼ï¼šç”¨ä¸­æ–‡æç¤ºè¾…åŠ©</li>
              <li>è¿›é˜¶æ¨¡å¼ï¼šç›´æ¥è‹±è¯­è¾“å‡º</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>å› æœè¡¨è¾¾çŸ©é˜µ</h2>
          <div class="sub" style="margin-bottom:12px">é€‰æ‹©ä¸€ç§æ–¹å¼å±•å¼€ï¼š</div>
          <div style="display:grid; gap:8px; font-size:14px">
            <div style="padding:10px; background:rgba(34,197,94,.1); border-radius:10px">
              <b>åŸºç¡€ï¼š</b>because it's <span class="pro-hint">useful/interesting</span>
            </div>
            <div style="padding:10px; background:rgba(77,150,255,.08); border-radius:10px" class="pro-hint">
              <b>è¿›é˜¶ï¼š</b>also because... / which helps me...
            </div>
            <div style="padding:10px; background:rgba(251,191,36,.1); border-radius:10px" class="pro-hint">
              <b>é«˜çº§ï¼š</b>The reason is that...
            </div>
          </div>
        </div>
      `;
    },
    onMount: ()=> startMiniTimer('prepTimer', 3)
  },

  // 3-4. ä¸ªäººä¿¡æ¯è¯æ±‡ï¼ˆä¸»é¢˜èšç±»ï¼‰
  {
    title:"ä¸ªäººä¿¡æ¯1", stage:"è¯æ±‡ Â· åŸºç¡€ä¿¡æ¯", rightMeta:"3ä¸ªæ ¸å¿ƒè¯",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>ğŸ‘¤ å…³äºæˆ‘</h2>
          <div class="sub">ç‚¹å‡»å¡ç‰‡â†’å¬å‘éŸ³â†’è¯´å‡º2ä¸ªå¥å­</div>
          <div class="grid6" id="personal1"></div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ å¿«é€Ÿè¾“å‡º</div>
            <ul>
              <li>ä»»é€‰2ä¸ªè¯ï¼Œå„è¯´2å¥è¯</li>
              <li>åŸºç¡€ï¼šç”¨æç¤ºå¥å‹</li>
              <li>è¿›é˜¶ï¼šè‡ªç”±å‘æŒ¥</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>åœºæ™¯æŒ‘æˆ˜</h2>
          <div class="scene" style="height:180px; background:linear-gradient(135deg, rgba(77,150,255,.1), rgba(251,113,133,.08)); display:grid; place-items:center; font-size:16px">
            <div style="text-align:center">
              <div style="font-size:36px">ğŸ‘‹</div>
              <div>æ–°åŒå­¦é—®ï¼šWhat's your name?</div>
            </div>
          </div>
          <div style="margin-top:12px; font-size:14px; color:var(--mut)">
            å€’è®¡æ—¶: <span id="microTimer1">15</span>ç§’
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      const host = document.getElementById('personal1');
      curriculum.topics.personal.slice(0,3).forEach(item=>{
        host.appendChild(makeTileCard({...item, ic:'tag'}, 'æ ¸å¿ƒ', getCurrentMode()));
      });
      startMiniTimer('microTimer1', 15);
    }
  },
  {
    title:"ä¸ªäººä¿¡æ¯2", stage:"è¯æ±‡ Â· æ‰©å±•ä¿¡æ¯", rightMeta:"3ä¸ªæ ¸å¿ƒè¯",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>ğŸ‘¤ æˆ‘çš„ç”Ÿæ´»</h2>
          <div class="sub">ç‚¹å‡»å¡ç‰‡â†’å¬å‘éŸ³â†’è¯´å‡º2ä¸ªå¥å­</div>
          <div class="grid6" id="personal2"></div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ å¥å­è¿æ¥</div>
            <ul>
              <li>ç”¨"and"è¿æ¥ä¸¤ä¸ªä¿¡æ¯</li>
              <li>ä¾‹ï¼šI live in Beijing and I live with my parents.</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>å¯¹æ¯”ç»ƒä¹ </h2>
          <div style="display:grid; gap:12px">
            <div style="background:rgba(77,150,255,.08); padding:14px; border-radius:14px">
              <div class="mini">ä½åœ¨<b>åœ°æ–¹</b>ï¼š</div>
              <div style="font-size:18px; margin-top:6px">I live <b>in</b> Beijing.</div>
            </div>
            <div style="background:rgba(34,197,94,.08); padding:14px; border-radius:14px">
              <div class="mini">å’Œ<b>äºº</b>ä¸€èµ·ä½ï¼š</div>
              <div style="font-size:18px; margin-top:6px">I live <b>with</b> my parents.</div>
            </div>
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      const host = document.getElementById('personal2');
      curriculum.topics.personal.slice(3).forEach(item=>{
        host.appendChild(makeTileCard({...item, ic:'pin'}, 'æ ¸å¿ƒ', getCurrentMode()));
      });
    }
  },

  // 5. å¾®å‹è¾“å‡ºé¡µ
  {
    title:"è¾“å‡ºç»ƒä¹ 1", stage:"è¾“å‡º Â· ä¸ªäººä¿¡æ¯", one:true, rightMeta:"40ç§’",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>ğŸ¤ ä¸ªäººä»‹ç»</h1>
          <div class="sub">ä½¿ç”¨æœ¬é¡µæ‰€å­¦è¯æ±‡ï¼Œè¿ç»­è¯´40ç§’</div>
          <div class="scene" style="height:200px; background:linear-gradient(135deg, rgba(251,113,133,.08), rgba(34,197,94,.08)); display:grid; place-items:center">
            <div style="font-size:20px; text-align:center">
              <div style="margin-bottom:12px">å§“å + å¹´é¾„ + åŸå¸‚</div>
              <div class="mini" style="color:var(--mut)">è‡³å°‘6å¥è¯ï¼Œä½¿ç”¨1ä¸ªbecause</div>
            </div>
          </div>
          <div class="turn">
            <div class="tTitle">è¯„åˆ†æ ‡å‡†</div>
            <ul>
              <li>å†…å®¹å®Œæ•´ï¼šâœ“ å§“å âœ“ å¹´é¾„ âœ“ åŸå¸‚</li>
              <li>è¯­è¨€è´¨é‡ï¼šbecause Ã—1ï¼Œé«˜çº§è¯ Ã—1</li>
              <li>æµåˆ©åº¦ï¼šæ— æ˜æ˜¾é•¿åœé¡¿</li>
            </ul>
          </div>
          <div class="btnRow" style="justify-content:center; margin-top:16px">
            <button class="primary" onclick="startTimer(40)">å¼€å§‹è®¡æ—¶</button>
          </div>
        </div>
      `;
    }
  },

  // 6-7. å­¦æ ¡è¯æ±‡ï¼ˆä¸»é¢˜èšç±»ï¼‰
  {
    title:"å­¦æ ¡è¯æ±‡1", stage:"è¯æ±‡ Â· å­¦æ ¡æ¦‚å†µ", rightMeta:"3ä¸ªæ ¸å¿ƒè¯",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>ğŸ« æˆ‘çš„å­¦æ ¡</h2>
          <div class="sub">ç‚¹å‡»å¡ç‰‡â†’å¬å‘éŸ³â†’è¯´å‡º2ä¸ªå¥å­</div>
          <div class="grid6" id="school1"></div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ å­¦æ ¡æè¿°</div>
            <ul>
              <li>ç”¨"big/clean/friendly"æè¿°å­¦æ ¡</li>
              <li>ä¾‹ï¼šMy school is big because...</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>é«˜çº§è¯æ±‡åº“</h2>
          <div class="btnRow" id="powerSchool"></div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ å‡çº§å¥å­</div>
            <ul><li>ä½¿ç”¨2ä¸ªé«˜çº§è¯æè¿°å­¦æ ¡</li></ul>
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      const host = document.getElementById('school1');
      curriculum.topics.school.slice(0,3).forEach(item=>{
        host.appendChild(makeTileCard({...item, ic:'school'}, 'æ ¸å¿ƒ', getCurrentMode()));
      });
      const powerHost = document.getElementById('powerSchool');
      curriculum.powerWords.slice(0,6).forEach((w,i)=>{
        const btn = document.createElement('button');
        btn.className = i%2===0 ? 'blue' : 'pink';
        btn.textContent = w;
        btn.onclick = ()=> recordStudentAction('powerWord', w);
        powerHost.appendChild(btn);
      });
    }
  },
  {
    title:"å­¦æ ¡è¯æ±‡2", stage:"è¯æ±‡ Â· å­¦ä¹ ä¸æ´»åŠ¨", rightMeta:"3ä¸ªæ ¸å¿ƒè¯",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>ğŸ“š å­¦ä¹ ä¸è¯¾å</h2>
          <div class="sub">ç‚¹å‡»å¡ç‰‡â†’å¬å‘éŸ³â†’è¯´å‡º2ä¸ªå¥å­</div>
          <div class="grid6" id="school2"></div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ è¿è´¯è¡¨è¾¾</div>
            <ul>
              <li>ç”¨"and/then/also"è¿æ¥æ´»åŠ¨</li>
              <li>ä¾‹ï¼šI study English and then I do homework.</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>è¯­å—æŒ‘æˆ˜</h2>
          <div class="btnRow">
            <button class="amber" onclick="useChunk('my favourite subject')">my favourite subject</button>
            <button class="amber" onclick="useChunk('after-school club')">after-school club</button>
          </div>
          <div id="chunkOutput" class="scene" style="height:120px; margin-top:10px; display:grid; place-items:center; font-size:16px; color:var(--mut)">
            é€‰æ‹©ä¸€ä¸ªè¯­å—ï¼Œè¯´2ä¸ªå¥å­
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      const host = document.getElementById('school2');
      curriculum.topics.school.slice(3).forEach(item=>{
        host.appendChild(makeTileCard({...item, ic:'book'}, 'æ ¸å¿ƒ', getCurrentMode()));
      });
    }
  },

  // 8. å­¦æ ¡è¯é¢˜è¾“å‡ºé¡µ
  {
    title:"è¾“å‡ºç»ƒä¹ 2", stage:"è¾“å‡º Â· å­¦æ ¡ç”Ÿæ´»", one:true, rightMeta:"50ç§’",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>ğŸ¤ å­¦æ ¡ä»‹ç»</h1>
          <div class="sub">ä½¿ç”¨æœ¬é¡µæ‰€å­¦è¯æ±‡ï¼Œè¿ç»­è¯´50ç§’</div>
          <div class="scene" style="height:200px; background:linear-gradient(135deg, rgba(77,150,255,.08), rgba(139,92,246,.08)); display:grid; place-items:center">
            <div style="font-size:20px; text-align:center">
              <div style="margin-bottom:12px">å­¦æ ¡ + ç§‘ç›® + è¯¾åæ´»åŠ¨</div>
              <div class="mini" style="color:var(--mut)">è‡³å°‘7å¥è¯ï¼Œbecause Ã—2ï¼Œé«˜çº§è¯ Ã—2</div>
            </div>
          </div>
          <div class="turn">
            <div class="tTitle">å‚è€ƒç»“æ„</div>
            <ul>
              <li>å¼€å¤´ï¼šI study at ___ School.</li>
              <li>ä¸»ä½“ï¼šMy favourite subject is ___ because ___ and also because ___.</li>
              <li>ç»“å°¾ï¼šAfter school, I ___.</li>
            </ul>
          </div>
          <div class="btnRow" style="justify-content:center; margin-top:16px">
            <button class="primary" onclick="startTimer(50)">å¼€å§‹è®¡æ—¶</button>
          </div>
        </div>
      `;
    }
  },

  // 9. é”™è¯¯çº æ­£ï¼ˆè¦†ç›–å¤šç§ç±»å‹ï¼‰
  {
    title:"é”™è¯¯çº æ­£", stage:"å‡†ç¡®æ€§ Â· æ”¹é”™", rightMeta:"4ç§å¸¸è§é”™è¯¯",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h2>ğŸ› ï¸ å¸¸è§é—®é¢˜çº æ­£</h2>
          <div class="sub">ç‚¹å‡»å¡ç‰‡â†’æŸ¥çœ‹æ­£ç¡®ç­”æ¡ˆâ†’æ¨¡ä»¿</div>
          <div class="grid6" id="errorGrid"></div>
          <div class="turn">
            <div class="tTitle">ğŸ¤ é¿å…é”™è¯¯</div>
            <ul>
              <li>ä»‹è¯ï¼šinï¼ˆåŸå¸‚ï¼‰/ atï¼ˆå­¦æ ¡ï¼‰/ withï¼ˆäººï¼‰</li>
              <li>ä¸‰å•ï¼šhe/she/itåé¢åŠ¨è¯åŠ s</li>
            </ul>
          </div>
        </div>
      `;
    },
    right:(root)=>{
      root.innerHTML = `
        <div class="card soft">
          <h2>è‡ªæˆ‘æ£€æŸ¥æ¸…å•</h2>
          <div style="display:grid; gap:10px; font-size:14px">
            ${[
              "âœ“ ä»‹è¯ä½¿ç”¨æ­£ç¡®ï¼Ÿ",
              "âœ“ he/sheæ²¡æœ‰æ··æ·†ï¼Ÿ",
              "âœ“ åŠ¨è¯ä¸‰å•å½¢å¼ï¼Ÿ",
              "âœ“ becauseåé¢æœ‰å®Œæ•´å¥å­ï¼Ÿ"
            ].map(item=>`<div style="padding:10px; background:rgba(77,150,255,.05); border-radius:10px">${item}</div>`).join('')}
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      const host = document.getElementById('errorGrid');
      curriculum.errors.forEach(err=>{
        host.appendChild(makeErrorCard(err));
      });
    }
  },

  // 10. è€ƒè¯•æ¨¡æ‹Ÿ
  {
    title:"è€ƒè¯•æ¨¡æ‹Ÿ", stage:"å®æˆ˜ Â· äººæœºå¯¹è¯", one:true, rightMeta:"6ä¸ªé—®é¢˜",
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>ğŸ“ KET Part 1 æ¨¡æ‹Ÿ</h1>
          <div class="sub">å›ç­”æ‰€æœ‰é—®é¢˜ï¼Œæ¯ä¸ªé—®é¢˜2å¥è¯</div>
          <div class="scene" style="height:260px">
            <div id="examQ" style="font-size:24px; text-align:center; margin-bottom:20px; color:var(--ink)">
              ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹
            </div>
            <div id="examA" style="font-size:16px; color:var(--mut); text-align:center; min-height:60px">
              ä½ çš„ç­”æ¡ˆä¼šè‡ªåŠ¨"æäº¤"ï¼ˆæ¨¡æ‹Ÿï¼‰
            </div>
          </div>
          <div class="btnRow" style="justify-content:center">
            <button class="primary" onclick="nextExamQ()">ä¸‹ä¸€ä¸ªé—®é¢˜</button>
            <button onclick="showExamTip()">æç¤º</button>
          </div>
          <div class="turn">
            <div class="tTitle">ç­”é¢˜è¿›åº¦</div>
            <ul>
              <li>å·²ç­”ï¼š<span id="qCount">0</span> / 6</li>
              <li>ä½¿ç”¨becauseï¼š<span id="bcCount">0</span>æ¬¡</li>
            </ul>
          </div>
        </div>
      `;
    }
  },

  // 11. æ€»ç»“é¡µ
  {
    title:"ä»»åŠ¡å®Œæˆ", stage:"ç»“æŸ", one:true,
    left:(root)=>{
      root.innerHTML = `
        <div class="card">
          <h1>ğŸ‰ è¯¾å ‚ä»»åŠ¡å®Œæˆï¼</h1>
          <div class="sub">ä½ çš„è¿›æ­¥ï¼š</div>
          <div class="scene" style="height:180px; background:linear-gradient(135deg, rgba(34,197,94,.1), rgba(77,150,255,.08)); display:grid; place-items:center; font-size:18px">
            <div style="text-align:center">
              <div id="finalScore" style="font-size:36px; color:var(--green); margin-bottom:10px">85%</div>
              <div class="mini">å‡†ç¡®ç‡ + æµåˆ©åº¦ + å®Œæ•´åº¦</div>
            </div>
          </div>
          <div class="turn">
            <div class="tTitle">è¯¾åä½œä¸š</div>
            <ul>
              <li>ç”¨å½•éŸ³Appå½•åˆ¶1åˆ†é’Ÿè‡ªæˆ‘ä»‹ç»</li>
              <li>å°è¯•ä½¿ç”¨ä»Šå¤©å­¦çš„2ä¸ªæ–°è¯­å—</li>
            </ul>
          </div>
        </div>
      `;
    },
    onMount: ()=>{
      // æ¨¡æ‹Ÿè¯„åˆ†
      const data = JSON.parse(localStorage.getItem('ketSpeakingData') || '{}');
      const score = Math.min(95, 60 + Object.keys(data).length * 5);
      document.getElementById('finalScore').textContent = score + '%';
    }
  }
];

/* =========================
   éš¾åº¦æ¨¡å¼ç®¡ç†
   ========================= */
let currentMode = 'basic';
function getCurrentMode(){ return currentMode; }
function setMode(mode){
  currentMode = mode;
  document.getElementById('modeBasic').classList.toggle('active', mode === 'basic');
  document.getElementById('modePro').classList.toggle('active', mode === 'pro');
  document.getElementById('deck').dataset.level = mode;
  
  // é‡æ–°æ¸²æŸ“å½“å‰å¹»ç¯ç‰‡
  show(idx);
}

/* =========================
   æ•™å¸ˆé¢æ¿
   ========================= */
function toggleTeacher(){
  const panel = document.getElementById('teacherPanel');
  panel.classList.toggle('open');
  updateTeacherPanel();
}

function updateTeacherPanel(){
  const data = JSON.parse(localStorage.getItem('ketSpeakingData') || '{}');
  const errorStats = document.getElementById('errorStats');
  const classProgress = document.getElementById('classProgress');
  
  // é«˜é¢‘é”™è¯¯
  const errors = Object.entries(data).filter(([k,v])=>v>1 && k.includes('é”™è¯¯'));
  errorStats.innerHTML = errors.length ? errors.map(([k,v])=>`
    <div class="error-card">
      <h4>${k}</h4>
      <p>å‡ºç°${v}æ¬¡</p>
      <div class="heat-bar"><div class="heat-fill" style="width:${Math.min(100, v*30)}%"></div></div>
    </div>
  `).join('') : '<p>æš‚æ— é”™è¯¯æ•°æ®</p>';
  
  // ç­çº§è¿›åº¦æ¨¡æ‹Ÿ
  classProgress.innerHTML = `
    <div style="display:grid; gap:8px; font-size:13px">
      <div style="display:flex; justify-content:space-between">
        <span>å®Œæˆè¯æ±‡ç»ƒä¹ </span>
        <span style="color:var(--green)">85%</span>
      </div>
      <div style="display:flex; justify-content:space-between">
        <span>å®Œæˆè¾“å‡ºç»ƒä¹ </span>
        <span style="color:var(--amber)">60%</span>
      </div>
      <div style="display:flex; justify-content:space-between">
        <span>ä¸»åŠ¨ä½¿ç”¨because</span>
        <span style="color:var(--pink)">3.2æ¬¡/äºº</span>
      </div>
    </div>
  `;
}

/* =========================
   å¾®å‹è®¡æ—¶å™¨
   ========================= */
function startMiniTimer(id, seconds){
  const el = document.getElementById(id);
  if(!el) return;
  let t = seconds;
  el.textContent = t;
  const interval = setInterval(()=>{
    t--;
    el.textContent = t;
    if(t<=0){
      clearInterval(interval);
      el.textContent = "æ—¶é—´åˆ°ï¼";
    }
  }, 1000);
}

/* =========================
   è¯­å—åŠŸèƒ½
   ========================= */
function useChunk(chunk){
  const output = document.getElementById('chunkOutput');
  const chunkData = curriculum.chunks.find(c=>c.w===chunk);
  if(!output || !chunkData) return;
  
  output.innerHTML = `
    <div style="background:#fff; padding:16px; border-radius:14px; text-align:center">
      <div style="font-size:18px; margin-bottom:8px"><b>${chunk}</b></div>
      <div style="color:var(--mut); font-size:14px">${chunkData.a}</div>
      <div class="mini" style="margin-top:10px">+ 1ä¸ªç»†èŠ‚å¥å­</div>
    </div>
  `;
  recordStudentAction('chunk', chunk);
}

/* =========================
   è€ƒè¯•æ¨¡æ‹Ÿ
   ========================= */
let examIndex = 0, becauseCount = 0;
const allExamQs = [...curriculum.examQs.personal, ...curriculum.examQs.school];
function nextExamQ(){
  const qEl = document.getElementById('examQ');
  const aEl = document.getElementById('examA');
  const countEl = document.getElementById('qCount');
  
  if(examIndex >= allExamQs.length){
    qEl.innerHTML = '<div style="color:var(--green)">è€ƒè¯•å®Œæˆï¼</div>';
    return;
  }
  
  qEl.textContent = allExamQs[examIndex];
  aEl.innerHTML = '<div style="color:var(--mut)">è¯·å£å¤´å›ç­”...</div>';
  
  // æ¨¡æ‹Ÿç­”æ¡ˆåˆ†æ
  setTimeout(()=>{
    aEl.innerHTML = `
      <div style="background:rgba(34,197,94,.1); padding:12px; border-radius:10px; margin-top:10px">
        <div style="font-size:14px; color:var(--ink)">âœ“ å›ç­”äº†2å¥è¯</div>
        ${Math.random()>.5 ? '<div style="font-size:13px; color:var(--green); margin-top:4px">âœ“ ä½¿ç”¨äº†because</div>' : '<div style="font-size:13px; color:var(--pink); margin-top:4px">âš  å»ºè®®åŠ because</div>'}
      </div>
    `;
    if(Math.random()>.5){
      becauseCount++;
      document.getElementById('bcCount').textContent = becauseCount;
    }
  }, 3000);
  
  examIndex++;
  countEl.textContent = examIndex;
  recordStudentAction('examQ', allExamQs[examIndex-1]);
}

function showExamTip(){
  const tips = [
    'æ¯ä¸ªé—®é¢˜å›ç­”<b>2å¥è¯</b>ï¼šç­”æ¡ˆ+ç»†èŠ‚',
    'ä½¿ç”¨<b>because</b>ç»™å‡ºç†ç”±',
    'æè¿°å­¦æ ¡ç”¨<b>friendly/interesting</b>ç­‰é«˜çº§è¯'
  ];
  alert(`æç¤ºï¼š${tips[Math.floor(Math.random()*tips.length)]}`);
}

/* =========================
   å¹»ç¯ç‰‡æ¸²æŸ“ç³»ç»Ÿ
   ========================= */
function slideShell({title, stage, rightMeta, one=false}){
  const s = document.createElement('section');
  s.className = 'slide';
  s.dataset.title = title;
  s.dataset.level = currentMode;
  
  const header = document.createElement('div');
  header.className = 'header';
  header.innerHTML = `
    <div class="badge"><span class="dot"></span> ${stage}</div>
    <div class="meta">
      <span class="pill" data-count>1 / ${slides.length}</span>
      ${rightMeta ? `<span class="pill">${rightMeta}</span>` : ''}
      <button class="blue" onclick="togglePicker(true)">èœå•</button>
    </div>
  `;
  
  const wrap = document.createElement('div');
  wrap.className = 'wrap' + (one ? ' one' : '');
  
  s.appendChild(header);
  s.appendChild(wrap);
  return {s, wrap};
}

const deck = document.getElementById('deck');
const slides = [];
slideDefs.forEach(def=>{
  const {s, wrap} = slideShell({
    title: def.title,
    stage: def.stage,
    rightMeta: def.rightMeta,
    one: !!def.one
  });
  
  if(def.one){
    const slot = document.createElement('div'); slot.className = 'slot';
    wrap.appendChild(slot);
    def.left(slot);
  } else {
    const left = document.createElement('div'); left.className = 'slot';
    const right = document.createElement('div'); right.className = 'slot';
    wrap.appendChild(left); wrap.appendChild(right);
    def.left(left);
    if(def.right) def.right(right);
  }
  
  deck.appendChild(s);
  slides.push({el:s, onMount:def.onMount||null, title:def.title});
});

// åº•éƒ¨å¯¼èˆª
const nav = document.createElement('div');
nav.id = "nav";
nav.innerHTML = `
  <button class="navBtn secondary" id="prev">â¬… ä¸Šä¸€é¡µ</button>
  <div class="center">
    <span id="navTitle">æ¬¢è¿</span>
    <div class="progress" aria-label="è¿›åº¦"><div class="bar" id="bar"></div></div>
    <span id="count">1 / ${slides.length}</span>
  </div>
  <button class="navBtn" id="next">ä¸‹ä¸€é¡µ â¡</button>
`;
deck.appendChild(nav);

let idx = 0;
function show(i){
  idx = Math.max(0, Math.min(slides.length-1, i));
  slides.forEach((s,k)=>s.el.classList.toggle('active', k===idx));
  
  const c = slides[idx].el.querySelector('[data-count]');
  if(c) c.textContent = `${idx+1} / ${slides.length}`;
  
  document.getElementById('navTitle').textContent = slides[idx].title;
  document.getElementById('count').textContent = `${idx+1} / ${slides.length}`;
  document.getElementById('prev').disabled = idx===0;
  document.getElementById('next').disabled = idx===slides.length-1;
  document.getElementById('bar').style.width = ((idx+1)/slides.length*100) + '%';
  
  if(slides[idx].onMount) slides[idx].onMount();
}
document.getElementById('prev').onclick = ()=>show(idx-1);
document.getElementById('next').onclick = ()=>show(idx+1);

// é”®ç›˜æ§åˆ¶
window.addEventListener('keydown', e=>{
  const k = e.key.toLowerCase();
  if(k==='arrowright' || k==='d') show(idx+1);
  if(k==='arrowleft' || k==='a') show(idx-1);
  if(k==='m') togglePicker(true);
  if(k==='escape') togglePicker(false);
});

// å¹»ç¯ç‰‡é€‰æ‹©å™¨
const picker = document.getElementById('picker');
const pickerList = document.getElementById('pickerList');
slides.forEach((s,i)=>{
  const b = document.createElement('div');
  b.className = 'jump';
  b.innerHTML = `<b>${i+1}. ${s.title}</b><small>${slideDefs[i].stage}</small>`;
  b.onclick = ()=>{ show(i); togglePicker(false); };
  pickerList.appendChild(b);
});
window.togglePicker = function(on){
  picker.classList.toggle('on', !!on);
  picker.setAttribute('aria-hidden', on ? 'false' : 'true');
};

// æ•™å¸ˆé¢æ¿
function updateTeacherPanel(){
  if(document.getElementById('teacherPanel').classList.contains('open')){
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè½®è¯¢åç«¯API
    setTimeout(updateTeacherPanel, 3000);
  }
}

show(0);
</script>
</body>
</html>